name: "ğŸ“¦ Release"

on:
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  tag_check:
    name: "ğŸ” Tag Check"
    runs-on: ubuntu-latest
    outputs:
      semver_match: ${{ steps.regex-match.outputs.match }}
    steps:
      - name: "ğŸ” Match SemVer Tag"
        uses: actions-ecosystem/action-regex-match@v2
        id: regex-match
        with:
          text: ${{ github.ref_name }}
          regex: '^v[0-9]+\\.[0-9]+\\.[0-9]+$'

  package:
    name: "ğŸ“¦ Package"
    runs-on: ubuntu-latest
    needs: [tag_check]
    if: ${{ needs.tag_check.outputs.semver_match != '' }}
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
      - name: "ğŸ“¦ Package"
        run: |
          mkdir -p dist
          VERSION="${GITHUB_REF_NAME}"
          git archive --format=tar.gz --output="dist/lode-${VERSION}.tar.gz" HEAD
          sha256sum "dist/lode-${VERSION}.tar.gz" > "dist/lode-${VERSION}.tar.gz.sha256"
      - name: "â¬†ï¸ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: release-dist
          path: dist/

  hold:
    name: "â¸ï¸ Release Approval"
    runs-on: ubuntu-latest
    needs: [package]
    environment:
      name: release
    steps:
      - name: "âœ… Await Approval"
        run: echo "Release approved; continuing."

  release:
    name: "ğŸš€ GitHub Release"
    runs-on: ubuntu-latest
    needs: [hold]
    steps:
      - name: "â¬‡ï¸ Download Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: release-dist
          path: dist
      - name: "ğŸš€ Create Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: dist/*
